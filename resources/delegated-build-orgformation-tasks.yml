
OrganizationUpdate:
  Type: update-organization
  Template: ./organization.yml
  TaskRoleName: XXX-organizationFormationBuildAccessRoleName

OrganizationBuild:
  Type: update-stacks
  Template: ./templates/org-formation-build.yml
  StackName: XXX-stackName
  Parameters:
    stateBucketName: XXX-stateBucketName
    resourcePrefix: XXX-resourcePrefix
    repositoryName: XXX-repositoryName
  DefaultOrganizationBindingRegion: XXX-region
  DefaultOrganizationBinding:
    Account: !Ref XXX-buildAccountLogicalName

MasterOrganizationFormationBuildRole:
  Type: update-stacks
  DependsOn: OrganizationBuild
  Template: ./templates/org-formation-build-role.yml
  StackName: XXX-roleStackName
  TerminationProtection: true
  IgnoreDuplicateStackName: true
  DefaultOrganizationBindingRegion: XXX-region
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  Parameters:
    assumeRolePrincipal: !CopyValue ['XXX-stackName-build-role-id', !Ref XXX-buildAccountLogicalName, XXX-region]

OrganizationFormationBuildRole:
  Type: update-stacks
  DependsOn: OrganizationBuild
  Template: ./templates/org-formation-build-role.yml
  StackName: XXX-roleStackName
  TerminationProtection: true
  IgnoreDuplicateStackName: true
  DefaultOrganizationBindingRegion: XXX-region
  DefaultOrganizationBinding:
    IncludeMasterAccount: false
    Account: '*'
    ExcludeAccount: !Ref XXX-buildAccountLogicalName
  Parameters:
    assumeRolePrincipal: !CopyValue ['XXX-stackName-build-role-id', !Ref XXX-buildAccountLogicalName, XXX-region]
  TaskRoleName: !GetAtt CurrentAccount.OrganizationAccessRoleName
  TaskViaRoleArn: !Sub 'arn:aws:iam::${MasterAccount}:role/XXX-organizationFormationBuildAccessRoleName'

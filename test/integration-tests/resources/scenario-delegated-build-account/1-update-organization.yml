
OrganizationUpdate:
  Type: update-organization
  Template: ./organization-2.yml
  TaskRoleName: 'OrganizationFormationBuildRole'

OrganizationFormationBuildRole:
  Type: update-stacks
  Template: ./build-role.yml
  StackName: org-formation-build-role
  TerminationProtection: true
  DefaultOrganizationBindingRegion: eu-west-1
  DefaultOrganizationBinding:
    IncludeMasterAccount: false # OrganizationFormationBuildRole must have been manually added to the build account in order to bootstrap
    ExcludeAccount:
    - !Ref OrganizationBuildAccount
    - !Ref AccountB
    - !Ref AccountC
    Account: '*'
  Parameters:
    buildAccountId: !Ref OrganizationBuildAccount
  TaskRoleName: 'OrganizationAccountAccessRole'
  TaskViaRoleArn: !Sub 'arn:aws:iam::${MasterAccount}:role/OrganizationFormationBuildRole'

OrganizationFormationBuildRoleB:
  Type: update-stacks
  Template: ./build-role.yml
  StackName: org-formation-build-role-b
  TerminationProtection: true
  DefaultOrganizationBindingRegion: eu-west-1
  DefaultOrganizationBinding:
    Account: !Ref AccountB
  Parameters:
    buildAccountId: !Ref OrganizationBuildAccount
  TaskRoleName: 'CustomCrossAccountRole'
  TaskViaRoleArn: !Sub 'arn:aws:iam::${MasterAccount}:role/OrganizationFormationBuildRole'

OrganizationFormationBuildRoleC:
  Type: update-stacks
  Template: ./build-role.yml
  StackName: org-formation-build-role-c
  TerminationProtection: true
  DefaultOrganizationBindingRegion: eu-west-1
  DefaultOrganizationBinding:
    Account: !Ref AccountC
  Parameters:
    buildAccountId: !Ref OrganizationBuildAccount
  TaskRoleName: 'AnotherCustomRole'
  TaskViaRoleArn: !Sub 'arn:aws:iam::${MasterAccount}:role/OrganizationFormationBuildRole'

BucketToAllAccounts:
  Type: update-stacks
  DependsOn: OrganizationFormationBuildRole
  Template: ./bucket.yml
  StackName: bucket
  DefaultOrganizationBindingRegion: eu-west-1
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
    Account: '*'

